<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>jWeather</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .nav-item {
            @apply text-white hover:text-gray-300 px-3 py-2 rounded-md text-sm font-medium;
        }
        .sub-nav-item {
            @apply text-gray-700 hover:bg-gray-200 block px-3 py-2 rounded-md text-base font-medium;
        }
        .alert-severe-thunderstorm-watch { background-color: #FFFFE0; }
        .alert-severe-thunderstorm-warning { background-color: #FFD700; color: #000000; }
        .alert-tornado-watch { background-color: #FFD2D2; }
        .alert-tornado-warning { background-color: #DC143C; color: #FFFFFF; }
        .hidden-by-default { display: none; }
    </style>
</head>
<body>

<!-- your existing body content here -->

<script>
    document.addEventListener("DOMContentLoaded", () => {
        async function geocodeLocation(query) {
            const encoded = encodeURIComponent(query);
            const url = `https://nominatim.openstreetmap.org/search?q=${encoded}&format=json&limit=1`;

            try {
                const response = await fetch(url, {
                    headers: {
                        'User-Agent': 'jWeatherApp/1.0 (your-email@example.com)'
                    }
                });
                const data = await response.json();
                if (data.length > 0) {
                    return {
                        latitude: parseFloat(data[0].lat),
                        longitude: parseFloat(data[0].lon)
                    };
                } else {
                    console.error("No geocoding results found for:", query);
                    return null;
                }
            } catch (error) {
                console.error("Geocoding error:", error);
                return null;
            }
        }

        async function fetchWeather(lat, lon) {
            const base = `https://api.weather.gov/points/${lat},${lon}`;
            try {
                const pointRes = await fetch(base);
                const pointData = await pointRes.json();
                const forecastUrl = pointData.properties.forecast;
                const conditionsUrl = pointData.properties.forecastHourly;
                const alertsUrl = `https://api.weather.gov/alerts/active?point=${lat},${lon}`;

                const forecastRes = await fetch(forecastUrl);
                const forecastData = await forecastRes.json();

                const hourlyRes = await fetch(conditionsUrl);
                const hourlyData = await hourlyRes.json();

                const alertsRes = await fetch(alertsUrl);
                const alertsData = await alertsRes.json();

                displayCurrentConditions(hourlyData);
                displayForecast(forecastData);
                displayAlerts(alertsData);
            } catch (e) {
                console.error("Error fetching weather data:", e);
            }
        }

        function displayCurrentConditions(data) {
            const current = data.properties.periods[0];
            const el = document.getElementById("current-conditions-content");
            el.innerHTML = `
                <p><strong>Condition:</strong> ${current.shortForecast}</p>
                <p><strong>Temperature:</strong> ${current.temperature} °F</p>
                <p><strong>Wind:</strong> ${current.windSpeed} ${current.windDirection}</p>
                <p><strong>Humidity:</strong> N/A</p>
                <p><strong>Dew Point:</strong> N/A</p>
            `;
        }

        function displayForecast(data) {
            const fiveDay = data.properties.periods.slice(0, 5);
            const sevenDay = data.properties.periods.slice(0, 7);

            const forecastEl = document.getElementById("forecast-content");
            forecastEl.innerHTML = fiveDay.map(day => `
                <div class="p-2 border rounded">
                    <h4 class="font-semibold">${day.name}</h4>
                    <img src="${day.icon}" alt="${day.shortForecast}" class="mx-auto">
                    <p>${day.temperature}°F</p>
                </div>
            `).join('');

            const sevenDayEl = document.getElementById("seven-day-forecast-content");
            sevenDayEl.innerHTML = sevenDay.map(day => `
                <div class="p-2 border rounded">
                    <h4 class="font-semibold">${day.name}</h4>
                    <img src="${day.icon}" alt="${day.shortForecast}" class="mx-auto">
                    <p>${day.temperature}°F</p>
                </div>
            `).join('');
        }

        function displayAlerts(data) {
            const card = document.getElementById("active-alerts-card");
            const container = document.getElementById("alerts-content");
            if (!data.features.length) {
                container.innerHTML = `<div class="bg-green-100 text-green-800 p-3 rounded-md">✅ No active alerts for this location.</div>`;
            } else {
                container.innerHTML = data.features.map(alert => {
                    let alertClass = "bg-gray-200";
                    const title = alert.properties.event.toLowerCase();
                    if (title.includes("tornado warning")) alertClass = "alert-tornado-warning";
                    else if (title.includes("tornado watch")) alertClass = "alert-tornado-watch";
                    else if (title.includes("severe thunderstorm warning")) alertClass = "alert-severe-thunderstorm-warning";
                    else if (title.includes("severe thunderstorm watch")) alertClass = "alert-severe-thunderstorm-watch";
                    return `
                        <div class="${alertClass} p-3 rounded">
                            <strong>${alert.properties.event}</strong><br>
                            Expires: ${new Date(alert.properties.ends).toLocaleString()}<br>
                            <button onclick="this.nextElementSibling.classList.toggle('hidden')" class="text-sm underline text-blue-700">More detail</button>
                            <div class="hidden mt-2 whitespace-pre-wrap text-sm">${alert.properties.description}</div>
                        </div>
                    `;
                }).join('');
            }
            card.classList.remove("hidden-by-default");
        }

        document.getElementById("search-button").addEventListener("click", async () => {
            const query = document.getElementById("location-search").value;
            const coords = await geocodeLocation(query);
            if (coords) {
                fetchWeather(coords.latitude, coords.longitude);
                document.getElementById("forecast-card").classList.remove("hidden-by-default");
                document.getElementById("radar-card").classList.remove("hidden-by-default");
                const radarEmbed = `<iframe width="100%" height="450" src="https://embed.windy.com/embed2.html?lat=${coords.latitude}&lon=${coords.longitude}&detailLat=${coords.latitude}&detailLon=${coords.longitude}&width=650&height=450&zoom=7&level=surface&overlay=radar&menu=&message=&marker=&calendar=&pressure=&type=map&location=coordinates&detail=&metricWind=default&metricTemp=default&radarRange=-1" frameborder="0"></iframe>`;
                document.getElementById("windy-radar-embed").innerHTML = radarEmbed;
            }
        });

        document.getElementById("toggle-forecast-days").addEventListener("click", () => {
            document.getElementById("seven-day-forecast-content").classList.toggle("hidden");
        });
    });
</script>
</body>
</html>
