<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>jWeather</title>

  <!-- TailwindCSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    /* ----------------------------
       Custom styles (using Tailwind)
       ---------------------------- */
    .card {
      @apply bg-white shadow-lg rounded-lg p-6 mb-6;
    }
    .group:hover .group-hover\:block {
      display: block;
    }
    .condition-summary-grid {
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 0.5rem 1rem;
      align-items: center;
    }
    .alert-item {
      @apply mb-3 rounded-lg shadow overflow-hidden;
    }
    .alert-button {
      @apply w-full flex justify-between items-center px-6 py-4 focus:outline-none;
    }
    .alert-details {
      @apply px-6 pb-4 hidden text-xs;
    }
    .prose {
      @apply max-w-none;
    }
    .prose h5 {
      @apply font-semibold mt-2 mb-1;
    }
    .prose p {
      @apply mb-2;
    }
    .prose-invert h5,
    .prose-invert p {
      /* for dark backgrounds if any */
    }
  </style>
</head>
<body class="bg-gray-100 font-sans">

  <!-- =====================
       HEADER (existing site header)
       ===================== -->
  <header class="bg-red-600 text-white p-4 shadow-md">
    <div class="container mx-auto flex justify-between items-center">
      <!-- Logo -->
      <div class="flex items-center">
        <svg class="w-10 h-10 mr-2 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round"
            d="M2.25 15a4.5 4.5 0 0 0 4.5 4.5H18a3.75 3.75 0 0 0 1.332-7.257 3 3 0 0 0-1.991-5.189 5.25 5.25 0 0 0-10.513 2.288c-.887-.462-1.868-.682-2.847-.682A4.5 4.5 0 0 0 2.25 15Z" />
        </svg>
        <h1 class="text-3xl font-bold">jWeather</h1>
      </div>

      <!-- Navigation Menu -->
      <nav>
        <ul class="flex space-x-6 text-lg">
          <li class="relative group">
            <a href="#" class="hover:text-gray-300 transition-colors duration-200">Severe Weather</a>
            <ul class="absolute right-0 lg:left-0 mt-2 w-56 bg-red-700 rounded-md shadow-xl hidden group-hover:block z-10 py-1">
              <li><a href="#" class="block px-4 py-2 text-sm hover:bg-red-800 transition-colors duration-150">Outlook</a></li>
              <li><a href="#" class="block px-4 py-2 text-sm hover:bg-red-800 transition-colors duration-150">Mesoscale Discussions</a></li>
              <li><a href="#" class="block px-4 py-2 text-sm hover:bg-red-800 transition-colors duration-150">Parameters</a></li>
              <li><a href="#" class="block px-4 py-2 text-sm hover:bg-red-800 transition-colors duration-150">Storm Reports</a></li>
              <li><a href="#" class="block px-4 py-2 text-sm hover:bg-red-800 transition-colors duration-150">Severe Weather 101</a></li>
            </ul>
          </li>
          <li><a href="#" class="hover:text-gray-300 transition-colors duration-200">Tropical</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <!-- =====================
       MAIN CONTENT
       ===================== -->
  <main class="container mx-auto p-4 md:p-6 space-y-8">

    <!-- ===========================
         SEARCH + CURRENT CONDITIONS
         =========================== -->
    <div class="flex flex-col lg:flex-row lg:space-x-6">
      <!-- Left: Search + Current -->
      <div class="lg:w-2/3 w-full">
        <section id="search-current-conditions-card" class="card">
          <h2 class="text-2xl font-semibold mb-4 text-gray-700">Search Location</h2>
          <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 mb-2">
            <input
              type="text"
              id="location-search-input"
              placeholder="Enter City, State or Zip Code"
              class="flex-grow p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none"
            />
            <button
              id="search-button"
              class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-md transition-colors duration-200"
            >
              Search
            </button>
          </div>
          <div id="search-status" class="text-sm text-gray-600 mt-2 hidden"></div>
          <div id="search-error-message" class="text-red-500 mt-2 hidden"></div>

          <!-- Current Conditions (initially hidden) -->
          <div id="current-conditions-display" class="hidden mt-4">
            <h3 class="text-xl font-semibold mb-3 text-gray-700">
              Current Conditions for
              <span id="location-name" class="text-blue-600">[Location]</span>
            </h3>
            <div id="current-condition-summary-box" class="bg-white p-4 rounded-lg mb-4 shadow">
              <div class="flex items-center mb-3 pb-3 border-b border-gray-300">
                <img
                  id="summary-condition-icon"
                  src="https://placehold.co/64x64/e2e8f0/94a3b8?text=N/A"
                  alt="Weather condition"
                  class="w-16 h-16 mr-4"
                />
                <p id="summary-condition-text" class="text-2xl font-bold text-gray-800">Fetching...</p>
              </div>
              <div class="condition-summary-grid text-sm sm:text-base">
                <p class="font-medium text-gray-600">Temperature:</p>
                <p id="summary-temp" class="font-semibold text-gray-800">[Temp]</p>

                <p class="font-medium text-gray-600">Feels Like:</p>
                <p id="summary-feels-like" class="font-semibold text-gray-800">[Feels Like]</p>

                <p class="font-medium text-gray-600">Wind:</p>
                <p id="summary-wind" class="font-semibold text-gray-800">[Wind]</p>

                <p class="font-medium text-gray-600">Humidity:</p>
                <p id="summary-humidity" class="font-semibold text-gray-800">[Humidity]</p>

                <p class="font-medium text-gray-600">Dew Point:</p>
                <div id="summary-dewpoint-container">
                  <span id="summary-dewpoint-value" class="font-semibold text-gray-800">[Value]</span>
                  <span id="summary-dewpoint-desc" class="text-gray-700 ml-1">([Description])</span>
                </div>
              </div>
            </div>
          </div>
        </section>
      </div>

      <!-- Right: Latest US Weather News -->
      <div class="lg:w-1/3 w-full">
        <section id="weather-news-card" class="card">
          <h2 class="text-2xl font-semibold mb-4 text-gray-700">Latest US Weather News</h2>
          <div id="news-content-area">
            <p class="text-gray-500">News content will appear here.</p>
          </div>
        </section>
      </div>
    </div>

    <!-- =====================
         ACTIVE ALERTS (with header)
         ===================== -->
    <section id="active-alerts-card" class="card">
      <!-- Header -->
      <h2 class="text-2xl font-semibold text-gray-700 mb-2">Active Alerts</h2>
      <hr class="border-gray-300 mb-4" />

      <!-- Container for all individual alert items -->
      <div id="alerts-content-area">
        <!-- Alerts will be injected here by JavaScript -->
      </div>
    </section>

    <!-- =============================
         FORECAST (Side-by-Side Day/Night)
         ============================= -->
    <section id="weather-forecast-card" class="card hidden">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-semibold text-gray-700">Weather Forecast</h2>
        <button id="toggle-forecast-days" class="text-blue-600 hover:underline text-sm focus:outline-none">
          Show 7-Day Forecast
        </button>
      </div>
      <div id="forecast-content-area" class="flex flex-col space-y-4">
        <!-- JavaScript injects Day/Night cards here using NWS icons -->
      </div>
    </section>

    <!-- =====================
         RADAR EMBED (hidden initially)
         ===================== -->
    <section id="radar-embed-card" class="card hidden">
      <h2 class="text-2xl font-semibold mb-4 text-gray-700">Reflective Radar</h2>
      <div
        id="windy-radar-container"
        class="w-full h-[300px] sm:h-[400px] md:h-[500px] bg-gray-200 rounded-md flex items-center justify-center overflow-hidden"
      >
        <p class="text-gray-500">Radar will load here once a location is searched.</p>
      </div>
    </section>
  </main>

  <!-- =====================
       FOOTER
       ===================== -->
  <footer class="text-center p-6 text-gray-500 text-sm border-t border-gray-200 mt-8">
    &copy; <span id="current-year"></span> jWeather. All rights reserved.
  </footer>

  <!-- =============================
       JAVASCRIPT SECTION
       ============================= -->
  <script>
    // --- API Configuration ---
    const NWS_API_BASE_URL = "https://api.weather.gov";
    const NWS_USER_AGENT = "(jWeather App, your.email@example.com)";
    const GEMINI_API_KEY = ""; // If you have a Gemini key, fill it here.

    // --- DOM Element References ---
    const searchInput = document.getElementById("location-search-input");
    const searchButton = document.getElementById("search-button");
    const searchStatusEl = document.getElementById("search-status");
    const searchErrorMessage = document.getElementById("search-error-message");

    const currentConditionsDisplay = document.getElementById("current-conditions-display");
    const locationNameSpan = document.getElementById("location-name");
    const summaryConditionIconEl = document.getElementById("summary-condition-icon");
    const summaryConditionTextEl = document.getElementById("summary-condition-text");
    const summaryTempEl = document.getElementById("summary-temp");
    const summaryFeelsLikeEl = document.getElementById("summary-feels-like");
    const summaryWindEl = document.getElementById("summary-wind");
    const summaryHumidityEl = document.getElementById("summary-humidity");
    const summaryDewpointValueEl = document.getElementById("summary-dewpoint-value");
    const summaryDewpointDescEl = document.getElementById("summary-dewpoint-desc");

    const activeAlertsCard = document.getElementById("active-alerts-card");
    const alertsContentArea = document.getElementById("alerts-content-area");

    const weatherForecastCard = document.getElementById("weather-forecast-card");
    const forecastContentArea = document.getElementById("forecast-content-area");
    const toggleForecastButton = document.getElementById("toggle-forecast-days");

    const radarCard = document.getElementById("radar-embed-card");
    const windyRadarContainer = document.getElementById("windy-radar-container");

    const newsCard = document.getElementById("weather-news-card");
    const newsContentArea = document.getElementById("news-content-area");

    // Sections revealed after a successful search
    const locationSpecificContent = [
      currentConditionsDisplay,
      activeAlertsCard,
      weatherForecastCard,
      radarCard
    ];

    // --- State Variables ---
    let isShowing7DayForecast = false;
    let storedForecastPeriods = null;

    // --- Utility Functions ---
    function showElement(element) {
      if (element) element.classList.remove("hidden");
    }
    function hideElement(element) {
      if (element) element.classList.add("hidden");
    }
    function updateSearchStatus(message) {
      if (!searchStatusEl) return;
      searchStatusEl.textContent = message;
      if (message) showElement(searchStatusEl);
      else hideElement(searchStatusEl);
    }
    function displaySearchError(message) {
      searchErrorMessage.textContent = message;
      showElement(searchErrorMessage);
      updateSearchStatus("");
    }
    function clearSearchError() {
      searchErrorMessage.textContent = "";
      hideElement(searchErrorMessage);
    }

    async function nwsFetch(url) {
      const response = await fetch(url, {
        headers: {
          "User-Agent": NWS_USER_AGENT,
          "Accept": "application/geo+json"
        }
      });
      if (!response.ok) {
        const errorText = await response.text();
        console.error(`NWS API Error ${response.status} for ${url}: ${errorText}`);
        throw new Error(`NWS API request failed: ${response.status}`);
      }
      return response.json();
    }

    function getDewPointDescription(dewPointF) {
      if (dewPointF == null || isNaN(dewPointF)) return "N/A";
      if (dewPointF < 50) return "Pleasantly Dry";
      if (dewPointF < 55) return "Comfortable";
      if (dewPointF < 60) return "Becoming a Bit Humid";
      if (dewPointF < 65) return "Humid";
      if (dewPointF < 70) return "Sticky";
      if (dewPointF < 75) return "Muggy & Uncomfortable";
      return "Oppressive";
    }

    // Helper to format expiration time
    function formatExpireTime(isoString) {
      if (!isoString) return "";
      const dt = new Date(isoString);
      return dt.toLocaleTimeString("en-US", {
        hour: "numeric",
        minute: "2-digit",
        timeZoneName: "short"
      });
    }

    // --- Footer Year ---
    document.getElementById("current-year").textContent = new Date().getFullYear();

    // --- Event Listeners ---
    searchButton.addEventListener("click", handleSearch);
    searchInput.addEventListener("keypress", (event) => {
      if (event.key === "Enter") handleSearch();
    });
    toggleForecastButton.addEventListener("click", () => {
      isShowing7DayForecast = !isShowing7DayForecast;
      displayForecast(storedForecastPeriods);
    });

    // --- Geocoding via Nominatim ---
    async function geocodeLocation(query) {
      updateSearchStatus("Fetching location...");
      const geocodeUrl = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&addressdetails=1&limit=1`;
      try {
        const response = await fetch(geocodeUrl, {
          headers: { "User-Agent": NWS_USER_AGENT }
        });
        if (!response.ok) {
          throw new Error(`Nominatim geocoding failed: ${response.status} ${response.statusText}`);
        }
        const data = await response.json();
        if (data && data.length > 0) {
          const firstResult = data[0];
          return {
            lat: parseFloat(firstResult.lat),
            lon: parseFloat(firstResult.lon),
            displayName: firstResult.display_name
          };
        } else {
          throw new Error(`Location "${query}" not found.`);
        }
      } catch (error) {
        console.error("Nominatim API call error:", error);
        throw new Error(`Geocoding service error: ${error.message}`);
      }
    }

    // --- Main Search Handler ---
    async function handleSearch() {
      const query = searchInput.value.trim();
      clearSearchError();
      locationSpecificContent.forEach(hideElement);

      if (!query) {
        displaySearchError("Please enter a location (City, State or Zip Code).");
        return;
      }

      searchButton.textContent = "Searching...";
      searchButton.disabled = true;

      try {
        // 1) Geocode
        const { lat, lon, displayName } = await geocodeLocation(query);
        locationNameSpan.textContent = displayName;
        updateSearchStatus("Fetching weather details...");

        // 2) NWS “points” endpoint
        const latFixed = +lat.toFixed(4);
        const lonFixed = +lon.toFixed(4);
        const pointsUrl = `${NWS_API_BASE_URL}/points/${latFixed},${lonFixed}`;
        const pointsData = await nwsFetch(pointsUrl);

        const forecastUrl = pointsData.properties.forecast;
        const forecastHourlyUrl = pointsData.properties.forecastHourly;
        const observationStationsUrl = pointsData.properties.observationStations;
        const alertsUrl = `${NWS_API_BASE_URL}/alerts/active?point=${latFixed},${lonFixed}`;

        // 3) Parallel requests
        const [
          hourlyDataResponse,
          forecastDataResponse,
          observationStationsResponse,
          alertsDataResponse
        ] = await Promise.all([
          nwsFetch(forecastHourlyUrl),
          nwsFetch(forecastUrl),
          nwsFetch(observationStationsUrl),
          nwsFetch(alertsUrl)
        ]);

        // 4) Latest observation if available
        let currentPeriodData = hourlyDataResponse.properties.periods[0];
        let latestObservation = null;
        if (
          observationStationsResponse.features &&
          observationStationsResponse.features.length > 0
        ) {
          const latestObsUrl = `${observationStationsResponse.features[0].id}/observations/latest`;
          try {
            const obsResp = await nwsFetch(latestObsUrl);
            latestObservation = obsResp.properties;
          } catch (obsErr) {
            console.warn(`Could not fetch latest observation: ${obsErr.message}`);
          }
        }

        // 5) Display Current Conditions
        displayCurrentConditions(currentPeriodData, latestObservation);

        // 6) Display Forecast
        if (
          forecastDataResponse.properties &&
          forecastDataResponse.properties.periods
        ) {
          storedForecastPeriods = forecastDataResponse.properties.periods;
          isShowing7DayForecast = false;
          toggleForecastButton.textContent = "Show 7-Day Forecast";
          displayForecast(storedForecastPeriods);
        } else {
          throw new Error("Forecast data not available or unexpected format.");
        }

        // 7) Display Alerts
        displayActualAlerts(alertsDataResponse.features);

        // 8) Embed Radar
        embedWindyRadar(lat, lon);

        // 9) Reveal Sections
        locationSpecificContent.forEach(showElement);
        updateSearchStatus("Weather data loaded.");
        setTimeout(() => updateSearchStatus(""), 3000);
      } catch (error) {
        console.error("Search process failed:", error);
        displaySearchError(error.message);
        locationSpecificContent.forEach(hideElement);
      } finally {
        searchButton.textContent = "Search";
        searchButton.disabled = false;
        if (
          !searchErrorMessage.textContent &&
          searchStatusEl.textContent.includes("loaded")
        ) {
          setTimeout(() => updateSearchStatus(""), 3000);
        } else if (!searchErrorMessage.textContent) {
          updateSearchStatus("");
        }
      }
    }

    // --- Display Current Conditions ---
    function displayCurrentConditions(currentPeriod, observation) {
      let tempF = null;
      let windSpeed = "N/A";
      let windDir = "";
      let humidity = "N/A";
      let dewpointC = null;
      let iconUrl =
        currentPeriod?.icon || "https://placehold.co/64x64/e2e8f0/94a3b8?text=N/A";
      let conditionText = currentPeriod?.shortForecast || "N/A";

      if (observation) {
        if (
          observation.temperature &&
          observation.temperature.value !== null &&
          !isNaN(observation.temperature.value)
        ) {
          tempF = Math.round(observation.temperature.value * 9 / 5 + 32);
        }
        if (
          observation.windSpeed &&
          observation.windSpeed.value !== null &&
          !isNaN(observation.windSpeed.value)
        ) {
          windSpeed = Math.round(observation.windSpeed.value * 2.23694);
        }
        if (
          observation.windDirection &&
          observation.windDirection.value !== null
        ) {
          windDir = getWindDirectionAbbreviation(
            observation.windDirection.value
          );
        }
        if (
          observation.relativeHumidity &&
          observation.relativeHumidity.value !== null &&
          !isNaN(observation.relativeHumidity.value)
        ) {
          humidity = `${Math.round(observation.relativeHumidity.value)}%`;
        }
        if (
          observation.dewpoint &&
          observation.dewpoint.value !== null &&
          !isNaN(observation.dewpoint.value)
        ) {
          dewpointC = observation.dewpoint.value;
        }
        if (observation.icon) iconUrl = observation.icon;
        if (observation.textDescription) conditionText = observation.textDescription;
      } else if (currentPeriod) {
        if (currentPeriod.temperature !== null) {
          tempF =
            currentPeriod.temperatureUnit === "F"
              ? currentPeriod.temperature
              : Math.round(currentPeriod.temperature * 9 / 5 + 32);
        }
        if (currentPeriod.windSpeed) windSpeed = currentPeriod.windSpeed.split(" ")[0];
        if (currentPeriod.windDirection)
          windDir = currentPeriod.windDirection;
        if (
          currentPeriod.relativeHumidity &&
          currentPeriod.relativeHumidity.value !== null
        ) {
          humidity = `${currentPeriod.relativeHumidity.value}%`;
        }
        if (
          currentPeriod.dewpoint &&
          currentPeriod.dewpoint.value !== null
        ) {
          dewpointC = currentPeriod.dewpoint.value;
        }
      }

      summaryTempEl.textContent = tempF !== null ? `${tempF}°F` : "N/A";
      summaryWindEl.textContent =
        windSpeed !== "N/A" || windDir ? `${windSpeed} mph ${windDir}`.trim() : "N/A";
      summaryHumidityEl.textContent = humidity;

      const dewpointF =
        dewpointC !== null && !isNaN(dewpointC)
          ? Math.round(dewpointC * 9 / 5 + 32)
          : null;
      summaryDewpointValueEl.textContent =
        dewpointF !== null ? `${dewpointF}°F` : "N/A";
      summaryDewpointDescEl.textContent = `(${getDewPointDescription(dewpointF)})`;

      let feelsLikeText = "N/A";
      if (
        observation?.heatIndex?.value !== null &&
        !isNaN(observation?.heatIndex?.value)
      ) {
        feelsLikeText = `${Math.round(observation.heatIndex.value * 9 / 5 + 32)}°F (Heat Index)`;
      } else if (
        observation?.windChill?.value !== null &&
        !isNaN(observation?.windChill?.value)
      ) {
        feelsLikeText = `${Math.round(observation.windChill.value * 9 / 5 + 32)}°F (Wind Chill)`;
      } else if (tempF !== null) {
        feelsLikeText = `${tempF}°F`;
      }
      summaryFeelsLikeEl.textContent = feelsLikeText;

      summaryConditionIconEl.src = iconUrl;
      summaryConditionIconEl.alt = conditionText;
      summaryConditionTextEl.textContent = conditionText;
    }

    // --- Wind Direction Abbreviation ---
    function getWindDirectionAbbreviation(degrees) {
      if (degrees === null || isNaN(degrees)) return "";
      const val = Math.floor((degrees / 22.5) + 0.5);
      const arr = [
        "N", "NNE", "NE", "ENE", "E", "ESE", "SE", "SSE",
        "S", "SSW", "SW", "WSW", "W", "WNW", "NW", "NNW"
      ];
      return arr[val % 16];
    }

    // --- Display Forecast using NWS icons ---
    function displayForecast(periods) {
      forecastContentArea.innerHTML = "";

      if (!periods) {
        toggleForecastButton.textContent = isShowing7DayForecast
          ? "Show 5-Day Forecast"
          : "Show 7-Day Forecast";
        if (searchButton.disabled) {
          forecastContentArea.innerHTML = '<p class="text-gray-500 col-span-full text-center">Loading forecast...</p>';
        }
        return;
      }

      const numDaysToDisplay = isShowing7DayForecast ? 7 : 5;
      toggleForecastButton.textContent = isShowing7DayForecast
        ? "Show 5-Day Forecast"
        : "Show 7-Day Forecast";

      let dayCount = 0;
      for (let i = 0; i < periods.length && dayCount < numDaysToDisplay; ) {
        const dayPeriod = periods[i];
        if (!dayPeriod.isDaytime) {
          i++;
          continue;
        }

        // Find matching night period
        let nightPeriodForThisDay = null;
        if (
          i + 1 < periods.length &&
          !periods[i + 1].isDaytime &&
          new Date(periods[i + 1].startTime).toDateString() ===
            new Date(dayPeriod.startTime).toDateString()
        ) {
          nightPeriodForThisDay = periods[i + 1];
        }

        // Format date
        const rawDate = new Date(dayPeriod.startTime);
        const dateStr = rawDate.toLocaleDateString("en-US", {
          weekday: "short",
          month: "short",
          day: "numeric"
        });

        // Precipitation chance
        const dayPrecip = dayPeriod.probabilityOfPrecipitation?.value;
        const dayPrecipHTML = dayPrecip != null
          ? `<p class="text-xs text-gray-600 mt-1">Precip: ${dayPrecip}%</p>`
          : "";
        let nightPrecipHTML = "";
        if (nightPeriodForThisDay) {
          const np = nightPeriodForThisDay.probabilityOfPrecipitation?.value;
          if (np != null) {
            nightPrecipHTML = `<p class="text-xs text-gray-600 mt-1">Precip: ${np}%</p>`;
          }
        }

        // Icons
        const dayIconUrl = dayPeriod.icon || "";
        const nightIconUrl = nightPeriodForThisDay ? (nightPeriodForThisDay.icon || "") : "";

        // Day card
        const dayCardHTML = `
          <div class="flex-1 bg-gray-50 p-4 rounded-lg shadow">
            <p class="text-sm font-bold text-gray-700">${dateStr} • DAY</p>
            <div class="flex items-center mt-1 space-x-2">
              <p class="text-2xl font-bold text-red-600">${dayPeriod.temperature}°${dayPeriod.temperatureUnit}</p>
              <img src="${dayIconUrl}" alt="${dayPeriod.shortForecast}" class="w-10 h-10" />
            </div>
            <p class="mt-1 text-xs text-gray-600" title="${dayPeriod.shortForecast}">
              ${dayPeriod.shortForecast}
            </p>
            ${dayPrecipHTML}
          </div>`;

        // Night card
        const nightCardHTML = `
          <div class="flex-1 bg-gray-50 p-4 rounded-lg shadow">
            <p class="text-sm font-bold text-gray-700">${dateStr} • NIGHT</p>
            <div class="flex items-center mt-1 space-x-2">
              <p class="text-2xl font-bold text-blue-600">${
                nightPeriodForThisDay
                  ? `${nightPeriodForThisDay.temperature}°${nightPeriodForThisDay.temperatureUnit}`
                  : "N/A"
              }</p>
              <img src="${nightIconUrl}" alt="${nightPeriodForThisDay ? nightPeriodForThisDay.shortForecast : ""}" class="w-10 h-10" />
            </div>
            <p class="mt-1 text-xs text-gray-600" title="${
              nightPeriodForThisDay ? nightPeriodForThisDay.shortForecast : ""
            }">
              ${nightPeriodForThisDay ? nightPeriodForThisDay.shortForecast : ""}
            </p>
            ${nightPrecipHTML}
          </div>`;

        // Wrap
        const wrapperHTML = `
          <div class="flex flex-col sm:flex-row sm:space-x-4">
            ${dayCardHTML}
            ${nightCardHTML}
          </div>`;

        forecastContentArea.insertAdjacentHTML("beforeend", wrapperHTML);

        dayCount++;
        i++;
        if (nightPeriodForThisDay) i++;
      }
    }

    // --- Display Actual Alerts ---
    async function displayActualAlerts(alertFeatures) {
      alertsContentArea.innerHTML = "";
      if (!alertFeatures || alertFeatures.length === 0) {
        alertsContentArea.innerHTML = `
          <div class="flex items-center text-green-700 p-4 bg-green-100 rounded-lg shadow">
            <svg class="w-5 h-5 mr-2 text-green-500" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd"
                    d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                    clip-rule="evenodd"/>
            </svg>
            <span class="font-medium">No active alerts for this location.</span>
          </div>`;
        return;
      }

      alertFeatures.forEach((alert, index) => {
        const props = alert.properties;
        const eventLower = props.event.toLowerCase();
        const expireTime = formatExpireTime(props.ends || props.expires);
        const expireText = expireTime ? `Expires at ${expireTime}` : "";

        // Brief description: first full sentence
        let briefDesc = "";
        if (props.description) {
          const firstPeriod = props.description.indexOf(".");
          if (firstPeriod !== -1) {
            briefDesc = props.description.slice(0, firstPeriod + 1);
          } else {
            briefDesc = props.description;
          }
        }

        // Brief instructions: first full sentence
        let briefInst = "";
        if (props.instruction) {
          const firstPeriod = props.instruction.indexOf(".");
          if (firstPeriod !== -1) {
            briefInst = props.instruction.slice(0, firstPeriod + 1);
          } else {
            briefInst = props.instruction;
          }
        }

        let alertHTML = "";

        if (eventLower.includes("warning")) {
          // Warning style: red
          alertHTML = `
            <div class="alert-item border-l-4 border-red-700">
              <div class="bg-red-600 text-white">
                <button class="alert-button" data-alert-index="${index}">
                  <div class="flex items-center space-x-2">
                    <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd"
                        d="M8.257 3.099c.765-1.36 2.721-1.36 3.486 0l6.516 11.587c.75 1.336-.213 2.994-1.743 2.994H3.485c-1.53 0-2.493-1.658-1.743-2.994L8.257 3.1zM11 13a1 1 0 10-2 0 1 1 0 002 0zm-1-7.75a.75.75 0 01.75.75v3.5a.75.75 0 01-1.5 0v-3.5A.75.75 0 019 5.25z"
                        clip-rule="evenodd"/>
                    </svg>
                    <span class="font-semibold uppercase truncate">${props.event}</span>
                  </div>
                  <div class="flex items-center space-x-2">
                    <span class="text-xs">${expireText}</span>
                    <svg class="chevron w-5 h-5 text-white transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/>
                    </svg>
                  </div>
                </button>
              </div>
              <div class="alert-details bg-red-700 prose prose-invert text-xs text-white" data-alert-index="${index}">
                <p><strong>Description:</strong></p>
                <p>${briefDesc}</p>
                ${briefInst ? `<p><strong>Instructions:</strong></p><p>${briefInst}</p>` : ""}
                <p><strong>Expires:</strong> ${expireTime}</p>
              </div>
            </div>`;
        } else {
          // Watch/Advisory style: white
          alertHTML = `
            <div class="alert-item border-l-4 border-gray-300 bg-white">
              <button class="alert-button" data-alert-index="${index}">
                <div class="flex items-center space-x-2">
                  <svg class="w-5 h-5 text-yellow-600" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd"
                      d="M10 18a8 8 0 100-16 8 8 0 000 16zm.75-11.5a.75.75 0 00-1.5 0v3a.75.75 0 001.5 0v-3zm0 5a.75.75 0 00-1.5 0v.25a.75.75 0 001.5 0V11.5z"
                      clip-rule="evenodd"/>
                  </svg>
                  <span class="font-semibold uppercase truncate">${props.event}</span>
                </div>
                <div class="flex items-center space-x-2">
                  <span class="text-xs">${expireText}</span>
                  <svg class="chevron w-5 h-5 text-gray-600 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/>
                  </svg>
                </div>
              </button>
              <div class="alert-details bg-gray-50 prose text-gray-700 text-xs" data-alert-index="${index}">
                <p><strong>Description:</strong></p>
                <p>${briefDesc}</p>
                ${briefInst ? `<p><strong>Instructions:</strong></p><p>${briefInst}</p>` : ""}
                <p><strong>Expires:</strong> ${expireTime}</p>
              </div>
            </div>`;
        }

        alertsContentArea.insertAdjacentHTML("beforeend", alertHTML);
      });

      // Attach toggle behavior for each alert
      document.querySelectorAll("#alerts-content-area .alert-button").forEach((btn) => {
        btn.addEventListener("click", () => {
          const idx = btn.getAttribute("data-alert-index");
          const detailDiv = document.querySelector(
            `#alerts-content-area .alert-details[data-alert-index="${idx}"]`
          );
          const chevron = btn.querySelector(".chevron");
          if (detailDiv.classList.contains("hidden")) {
            detailDiv.classList.remove("hidden");
            chevron.classList.add("rotate-180");
          } else {
            detailDiv.classList.add("hidden");
            chevron.classList.remove("rotate-180");
          }
        });
      });
    }

    // --- Embed Windy Radar ---
    function embedWindyRadar(lat, lon) {
      const zoomLevel = 7;
      const radarUrl = `https://embed.windy.com/embed2.html?lat=${lat}&lon=${lon}&zoom=${zoomLevel}&layer=radar&menuDisable=true&messageDisable=true&markerDisable=true&calendar=now&pressureDisable=true&type=map&location=coordinates&detailDisable=true&metricWind=mph&metricTemp=%C2%B0F&radarRange=-1`;
      windyRadarContainer.innerHTML = `<iframe width="100%" height="100%" src="${radarUrl}" frameborder="0" allowfullscreen></iframe>`;
    }

    // --- Display Mock News (initial) ---
    function displayMockNews() {
      newsContentArea.innerHTML = "";
      const mockNewsItems = [
        {
          headline: "Major Storm System Developing in the Midwest",
          summary: "Forecasters are tracking a significant weather system moving eastward…",
          source: "NWS Weather Brief",
          date: "June 3, 2025"
        },
        {
          headline: "Heat Advisory Issued for Southwestern States",
          summary: "Temperatures expected to exceed 100°F in parts of Arizona and New Mexico.",
          source: "Local Weather Channel",
          date: "June 2, 2025"
        },
        {
          headline: "Tropical Update: Watching Area of Interest",
          summary: "A tropical wave over the Gulf of Mexico shows signs of development…",
          source: "National Hurricane Center",
          date: "June 3, 2025"
        }
      ];
      mockNewsItems.forEach(item => {
        const newsHTML = `
          <article class="mb-4 pb-4 border-b border-gray-200 last:border-b-0">
            <h3 class="font-semibold text-lg text-gray-800">
              <a href="#" target="_blank" rel="noopener noreferrer" class="hover:text-blue-600 hover:underline">
                ${item.headline}
              </a>
            </h3>
            <p class="text-sm text-gray-600 mt-1">${item.summary}</p>
            <p class="text-xs text-gray-400 mt-1">${item.source} — ${item.date}</p>
          </article>`;
        newsContentArea.insertAdjacentHTML("beforeend", newsHTML);
      });
    }

    // --- Initial Setup on Page Load ---
    document.querySelectorAll(".hidden-by-default").forEach(el => {
      el.classList.add("hidden");
      el.classList.remove("hidden-by-default");
    });
    locationSpecificContent.forEach(hideElement);
    displayMockNews();
  </script>
</body>
</html>
